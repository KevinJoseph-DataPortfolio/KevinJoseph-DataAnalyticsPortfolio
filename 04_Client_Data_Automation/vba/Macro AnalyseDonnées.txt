Sub AnalyseStatistique()

    Dim wsSource As Worksheet, wsDest As Worksheet
    Dim lastRow As Long, lastRowMois As Long
    Dim somme As Double, moyenne As Double
    Dim minVal As Double, maxVal As Double
    Dim countClients As Long
    Dim chartObj As ChartObject
    Dim rng As Range
    Dim dict As Object
    Dim i As Long, cle As Variant
    Dim dateVal As Variant, moisCle As String, montant As Double
    
    ' Définir la feuille source
    Set wsSource = ThisWorkbook.Sheets("Nettoyé")
    
    ' Supprimer l'onglet Analyse s'il existe déjà
    On Error Resume Next
    Application.DisplayAlerts = False
    ThisWorkbook.Sheets("Analyse").Delete
    Application.DisplayAlerts = True
    On Error GoTo 0
    
    ' Créer un nouvel onglet
    Set wsDest = ThisWorkbook.Sheets.Add
    wsDest.Name = "Analyse"
    
    ' Déterminer la dernière ligne
    lastRow = wsSource.Cells(wsSource.Rows.Count, 1).End(xlUp).Row
    
    ' Stats globales
    countClients = Application.WorksheetFunction.CountA(wsSource.Range("A2:A" & lastRow))
    somme = Application.WorksheetFunction.Sum(wsSource.Range("E2:E" & lastRow))
    moyenne = Application.WorksheetFunction.Average(wsSource.Range("E2:E" & lastRow))
    minVal = Application.WorksheetFunction.Min(wsSource.Range("E2:E" & lastRow))
    maxVal = Application.WorksheetFunction.Max(wsSource.Range("E2:E" & lastRow))
    
    ' Résultats globaux
    wsDest.Range("A1").Value = "Analyse Statistique"
    wsDest.Range("A1").Font.Bold = True
    
    wsDest.Range("A3").Value = "Nombre total de clients"
    wsDest.Range("B3").Value = countClients
    
    wsDest.Range("A4").Value = "Montant total cumulé"
    wsDest.Range("B4").Value = somme
    
    wsDest.Range("A5").Value = "Montant moyen par client"
    wsDest.Range("B5").Value = moyenne
    
    wsDest.Range("A6").Value = "Montant minimum"
    wsDest.Range("B6").Value = minVal
    
    wsDest.Range("A7").Value = "Montant maximum"
    wsDest.Range("B7").Value = maxVal
    
    wsDest.Range("A9").Value = "1er Quartile"
    wsDest.Range("B9").Value = Application.WorksheetFunction.Quartile(wsSource.Range("E2:E" & lastRow), 1)
    
    wsDest.Range("A10").Value = "Médiane"
    wsDest.Range("B10").Value = Application.WorksheetFunction.Median(wsSource.Range("E2:E" & lastRow))
    
    wsDest.Range("A11").Value = "3ème Quartile"
    wsDest.Range("B11").Value = Application.WorksheetFunction.Quartile(wsSource.Range("E2:E" & lastRow), 3)
    
    ' ---- Répartition par mois ----
    wsDest.Range("A13").Value = "Répartition par mois"
    wsDest.Range("A13").Font.Bold = True
    
    wsDest.Range("F2").Value = "Mois"
    wsDest.Range("G2").Value = "Montant total"
    
    ' Utiliser un dictionnaire pour agréger par mois
    Set dict = CreateObject("Scripting.Dictionary")
    
    For i = 2 To lastRow
        dateVal = wsSource.Cells(i, 4).Value ' Colonne D = Date
        If IsDate(dateVal) Then
            moisCle = Format(dateVal, "mm-yyyy")
            montant = wsSource.Cells(i, 5).Value
            If dict.exists(moisCle) Then
                dict(moisCle) = dict(moisCle) + montant
            Else
                dict.Add moisCle, montant
            End If
        End If
    Next i
    
    ' Écrire résultats mois uniques
    i = 3
    For Each cle In dict.Keys
        wsDest.Cells(i, 6).Value = cle
        wsDest.Cells(i, 7).Value = dict(cle)
        i = i + 1
    Next cle
    
    lastRowMois = i - 1
    
    ' Trier par date réelle
    wsDest.Range("F3:G" & lastRowMois).Sort Key1:=wsDest.Range("F3"), Order1:=xlAscending, Header:=xlNo
    
    ' ---- Créer un graphique en courbe ----
    Set rng = wsDest.Range("F2:G" & lastRowMois)
    Set chartObj = wsDest.ChartObjects.Add(Left:=300, Width:=500, Top:=20, Height:=300)
    
    With chartObj.Chart
        .SetSourceData Source:=rng
        .ChartType = xlLineMarkers
        .HasTitle = True
        .ChartTitle.Text = "Évolution des montants par mois"
        .Axes(xlCategory).HasTitle = True
        .Axes(xlCategory).AxisTitle.Text = "Mois"
        .Axes(xlCategory).TickLabels.NumberFormat = "mm-yyyy"
        .Axes(xlValue).HasTitle = True
        .Axes(xlValue).AxisTitle.Text = "Montant (€)"
    End With
    
    wsDest.Columns.AutoFit
    
    MsgBox "Analyse + courbe générées sans doublons dans l'onglet 'Analyse'.", vbInformation

End Sub
